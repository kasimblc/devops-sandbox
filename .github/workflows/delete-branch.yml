name: Delete Closed PR Branches

on:
  schedule:
    - cron: '0 3 * * 1' # Pazartesi 03:00 UTC
  workflow_dispatch:

jobs:
  delete-closed-pr-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI & jq
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: Delete closed PR branches
        env:
          GH_TOKEN: ${{ secrets.ALL }}  # Burada GITHUB_TOKEN deƒüil, GH_TOKEN kullanƒ±yoruz
        run: |
          echo "üîê Auth status:"
          gh auth status || echo "Auth not established"

          gh pr list --state closed --json headRefName \
          | jq -r '.[].headRefName' \
          | while read branch; do
              if [ "$branch" != "main" ] && [ "$branch" != "master" ]; then
                echo "üóëÔ∏è Deleting branch: $branch"
                gh api \
                  -X DELETE \
                  -H "Authorization: token $GH_TOKEN" \
                  /repos/${{ github.repository }}/git/refs/heads/$branch
              fi
            done
